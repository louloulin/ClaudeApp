# Claudia 部署指南

本文档详细说明了如何构建、打包和部署 Claudia 应用到不同平台。

## 目录

- [环境要求](#环境要求)
- [构建配置](#构建配置)
- [开发构建](#开发构建)
- [生产构建](#生产构建)
- [平台特定构建](#平台特定构建)
- [代码签名](#代码签名)
- [自动更新](#自动更新)
- [CI/CD 配置](#cicd-配置)
- [故障排除](#故障排除)

---

## 环境要求

### 基础要求

- **Node.js**: >= 18.0.0
- **Rust**: >= 1.70.0
- **npm**: >= 8.0.0 或 **yarn**: >= 1.22.0

### 平台特定要求

#### macOS
```bash
# 安装 Xcode Command Line Tools
xcode-select --install

# 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 添加 macOS 目标
rustup target add x86_64-apple-darwin
rustup target add aarch64-apple-darwin
```

#### Windows
```powershell
# 安装 Visual Studio Build Tools
# 下载并安装: https://visualstudio.microsoft.com/visual-cpp-build-tools/

# 安装 Rust
winget install Rustlang.Rustup

# 添加 Windows 目标
rustup target add x86_64-pc-windows-msvc
rustup target add i686-pc-windows-msvc
```

#### Linux
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y libwebkit2gtk-4.0-dev \
    build-essential \
    curl \
    wget \
    libssl-dev \
    libgtk-3-dev \
    libayatana-appindicator3-dev \
    librsvg2-dev

# 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 添加 Linux 目标
rustup target add x86_64-unknown-linux-gnu
```

---

## 构建配置

### Tauri 配置文件

`src-tauri/tauri.conf.json` 是主要的构建配置文件：

```json
{
  "build": {
    "beforeDevCommand": "npm run dev",
    "beforeBuildCommand": "npm run build",
    "devPath": "http://localhost:1420",
    "distDir": "../dist",
    "withGlobalTauri": false
  },
  "package": {
    "productName": "Claudia",
    "version": "0.1.0"
  },
  "tauri": {
    "allowlist": {
      "all": false,
      "shell": {
        "all": false,
        "open": true
      },
      "fs": {
        "all": true,
        "scope": ["$HOME/**", "$RESOURCE/**"]
      }
    },
    "bundle": {
      "active": true,
      "targets": "all",
      "identifier": "com.claudia.app",
      "icon": [
        "icons/32x32.png",
        "icons/128x128.png",
        "icons/128x128@2x.png",
        "icons/icon.icns",
        "icons/icon.ico"
      ]
    },
    "security": {
      "csp": null
    },
    "windows": [
      {
        "fullscreen": false,
        "resizable": true,
        "title": "Claudia",
        "width": 1200,
        "height": 800,
        "minWidth": 800,
        "minHeight": 600
      }
    ]
  }
}
```

### 环境变量配置

创建 `.env` 文件用于构建时配置：

```bash
# .env
TAURI_PRIVATE_KEY=path/to/private.key
TAURI_KEY_PASSWORD=your_key_password

# 代码签名 (macOS)
APPLE_CERTIFICATE=path/to/certificate.p12
APPLE_CERTIFICATE_PASSWORD=cert_password
APPLE_SIGNING_IDENTITY="Developer ID Application: Your Name"
APPLE_ID=your@apple.id
APPLE_PASSWORD=app_specific_password
APPLE_TEAM_ID=TEAM123456

# 代码签名 (Windows)
WINDOWS_CERTIFICATE=path/to/certificate.p12
WINDOWS_CERTIFICATE_PASSWORD=cert_password
```

---

## 开发构建

### 启动开发服务器

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run tauri:dev

# 或者分别启动前端和后端
npm run dev        # 启动 Vite 开发服务器
npm run tauri:dev  # 启动 Tauri 开发模式
```

### 开发模式特性

- **热重载**: 前端代码变更自动刷新
- **调试工具**: 可以使用浏览器开发者工具
- **快速编译**: Rust 代码增量编译
- **日志输出**: 详细的调试信息

### 调试配置

在 `src-tauri/tauri.conf.json` 中启用调试模式：

```json
{
  "build": {
    "devPath": "http://localhost:1420"
  },
  "tauri": {
    "bundle": {
      "active": false  // 开发模式下禁用打包
    }
  }
}
```

---

## 生产构建

### 基本构建命令

```bash
# 构建生产版本
npm run tauri:build

# 或者分步骤构建
npm run build           # 构建前端
npm run tauri:build     # 构建 Tauri 应用
```

### 构建输出

构建完成后，输出文件位于：

```
src-tauri/target/release/
├── bundle/
│   ├── macos/          # macOS 应用包
│   │   └── Claudia.app
│   ├── windows/        # Windows 安装程序
│   │   ├── Claudia_0.1.0_x64.msi
│   │   └── Claudia_0.1.0_x64-setup.exe
│   └── linux/          # Linux 包
│       ├── claudia_0.1.0_amd64.deb
│       └── claudia_0.1.0_amd64.AppImage
└── claudia            # 可执行文件
```

### 优化构建

#### Rust 优化

在 `src-tauri/Cargo.toml` 中配置：

```toml
[profile.release]
opt-level = "s"          # 优化大小
lto = true               # 链接时优化
codegen-units = 1        # 减少代码生成单元
panic = "abort"          # 减少二进制大小
strip = true             # 移除调试符号
```

#### 前端优化

在 `vite.config.ts` 中配置：

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  build: {
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,    // 移除 console.log
        drop_debugger: true    // 移除 debugger
      }
    },
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          ui: ['@radix-ui/react-dialog', '@radix-ui/react-dropdown-menu']
        }
      }
    }
  }
});
```

---

## 平台特定构建

### macOS 构建

#### 通用二进制文件 (Universal Binary)

```bash
# 添加目标架构
rustup target add x86_64-apple-darwin
rustup target add aarch64-apple-darwin

# 构建通用二进制文件
npm run tauri:build -- --target universal-apple-darwin
```

#### 应用签名和公证

```bash
# 设置环境变量
export APPLE_CERTIFICATE="path/to/certificate.p12"
export APPLE_CERTIFICATE_PASSWORD="password"
export APPLE_SIGNING_IDENTITY="Developer ID Application: Your Name"
export APPLE_ID="your@apple.id"
export APPLE_PASSWORD="app-specific-password"
export APPLE_TEAM_ID="TEAM123456"

# 构建并签名
npm run tauri:build
```

#### 创建 DMG 安装包

```bash
# 安装 create-dmg
brew install create-dmg

# 创建 DMG
create-dmg \
  --volname "Claudia" \
  --volicon "src-tauri/icons/icon.icns" \
  --window-pos 200 120 \
  --window-size 600 300 \
  --icon-size 100 \
  --icon "Claudia.app" 175 120 \
  --hide-extension "Claudia.app" \
  --app-drop-link 425 120 \
  "Claudia.dmg" \
  "src-tauri/target/release/bundle/macos/"
```

### Windows 构建

#### 多架构构建

```bash
# 添加目标架构
rustup target add x86_64-pc-windows-msvc
rustup target add i686-pc-windows-msvc

# 构建 64 位版本
npm run tauri:build -- --target x86_64-pc-windows-msvc

# 构建 32 位版本
npm run tauri:build -- --target i686-pc-windows-msvc
```

#### 代码签名

```bash
# 使用 signtool 签名
signtool sign /f certificate.p12 /p password /t http://timestamp.digicert.com "Claudia.exe"
```

#### 创建安装程序

Tauri 自动生成 MSI 和 NSIS 安装程序。可以在 `tauri.conf.json` 中自定义：

```json
{
  "tauri": {
    "bundle": {
      "windows": {
        "certificateThumbprint": null,
        "digestAlgorithm": "sha256",
        "timestampUrl": "http://timestamp.digicert.com",
        "wix": {
          "language": "en-US",
          "template": "path/to/custom.wxs"
        },
        "nsis": {
          "template": "path/to/custom.nsi",
          "languages": ["English", "SimpChinese"]
        }
      }
    }
  }
}
```

### Linux 构建

#### 多发行版支持

```bash
# 构建 DEB 包 (Debian/Ubuntu)
npm run tauri:build -- --target x86_64-unknown-linux-gnu

# 构建 RPM 包 (Red Hat/Fedora)
# 需要安装 rpm-build
sudo apt install rpm
npm run tauri:build

# 构建 AppImage
npm run tauri:build
```

#### 依赖管理

在 `tauri.conf.json` 中指定系统依赖：

```json
{
  "tauri": {
    "bundle": {
      "linux": {
        "deb": {
          "depends": [
            "libwebkit2gtk-4.0-37",
            "libgtk-3-0",
            "libayatana-appindicator3-1"
          ]
        },
        "rpm": {
          "depends": [
            "webkit2gtk3",
            "gtk3",
            "libappindicator-gtk3"
          ]
        }
      }
    }
  }
}
```

---

## 代码签名

### macOS 代码签名

#### 1. 获取开发者证书

```bash
# 从 Apple Developer 下载证书
# 导入到钥匙串
security import certificate.p12 -k ~/Library/Keychains/login.keychain
```

#### 2. 配置签名

```bash
# 查看可用的签名身份
security find-identity -v -p codesigning

# 设置签名身份
export APPLE_SIGNING_IDENTITY="Developer ID Application: Your Name (TEAM123456)"
```

#### 3. 公证配置

```bash
# 创建应用专用密码
# 在 Apple ID 账户页面生成

export APPLE_ID="your@apple.id"
export APPLE_PASSWORD="app-specific-password"
export APPLE_TEAM_ID="TEAM123456"
```

### Windows 代码签名

#### 1. 获取代码签名证书

```bash
# 从 CA (如 DigiCert, Sectigo) 购买证书
# 或使用 EV 代码签名证书
```

#### 2. 配置签名

```bash
# 使用 signtool
signtool sign /f "certificate.p12" /p "password" /tr "http://timestamp.digicert.com" /td sha256 /fd sha256 "Claudia.exe"
```

#### 3. 自动签名配置

在 `tauri.conf.json` 中：

```json
{
  "tauri": {
    "bundle": {
      "windows": {
        "certificateThumbprint": "CERT_THUMBPRINT",
        "digestAlgorithm": "sha256",
        "timestampUrl": "http://timestamp.digicert.com"
      }
    }
  }
}
```

---

## 自动更新

### 配置更新服务器

#### 1. 启用更新功能

在 `tauri.conf.json` 中：

```json
{
  "tauri": {
    "updater": {
      "active": true,
      "endpoints": [
        "https://releases.myapp.com/{{target}}/{{current_version}}"
      ],
      "dialog": true,
      "pubkey": "PUBLIC_KEY_HERE"
    }
  }
}
```

#### 2. 生成密钥对

```bash
# 生成更新密钥
npm run tauri:signer:generate -- -w ~/.tauri/myapp.key

# 获取公钥
npm run tauri:signer:sign ~/.tauri/myapp.key /path/to/app
```

#### 3. 更新服务器实现

```javascript
// Express.js 示例
app.get('/releases/:target/:version', (req, res) => {
  const { target, version } = req.params;
  
  // 检查是否有新版本
  const latestVersion = getLatestVersion();
  
  if (semver.gt(latestVersion, version)) {
    res.json({
      version: latestVersion,
      notes: "新版本发布说明",
      pub_date: new Date().toISOString(),
      platforms: {
        [target]: {
          signature: "SIGNATURE_HERE",
          url: `https://releases.myapp.com/download/${latestVersion}/${target}`
        }
      }
    });
  } else {
    res.status(204).send();
  }
});
```

### 前端更新检查

```typescript
import { checkUpdate, installUpdate } from '@tauri-apps/api/updater';
import { relaunch } from '@tauri-apps/api/process';

async function checkForUpdates() {
  try {
    const { shouldUpdate, manifest } = await checkUpdate();
    
    if (shouldUpdate) {
      // 显示更新对话框
      const userConfirmed = await showUpdateDialog(manifest);
      
      if (userConfirmed) {
        // 下载并安装更新
        await installUpdate();
        
        // 重启应用
        await relaunch();
      }
    }
  } catch (error) {
    console.error('检查更新失败:', error);
  }
}

// 应用启动时检查更新
useEffect(() => {
  checkForUpdates();
}, []);
```

---

## CI/CD 配置

### GitHub Actions

创建 `.github/workflows/build.yml`：

```yaml
name: Build and Release

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        platform: [macos-latest, ubuntu-20.04, windows-latest]
    
    runs-on: ${{ matrix.platform }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}
    
    - name: Install Linux dependencies
      if: matrix.platform == 'ubuntu-20.04'
      run: |
        sudo apt update
        sudo apt install -y libwebkit2gtk-4.0-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build app
      run: npm run tauri:build
      env:
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.platform }}
        path: |
          src-tauri/target/release/bundle/*/*
          !src-tauri/target/release/bundle/*/*.dSYM
  
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          **/*.dmg
          **/*.msi
          **/*.deb
          **/*.AppImage
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 自动化发布脚本

创建 `scripts/release.sh`：

```bash
#!/bin/bash

set -e

# 检查版本号
if [ -z "$1" ]; then
  echo "使用方法: $0 <version>"
  echo "示例: $0 1.0.0"
  exit 1
fi

VERSION=$1

# 更新版本号
echo "更新版本号到 $VERSION..."
npm version $VERSION --no-git-tag-version

# 更新 Tauri 配置
sed -i '' "s/\"version\": \".*\"/\"version\": \"$VERSION\"/g" src-tauri/tauri.conf.json
sed -i '' "s/version = \".*\"/version = \"$VERSION\"/g" src-tauri/Cargo.toml

# 构建应用
echo "构建应用..."
npm run tauri:build

# 创建 Git 标签
echo "创建 Git 标签..."
git add .
git commit -m "chore: bump version to $VERSION"
git tag -a "v$VERSION" -m "Release v$VERSION"

# 推送到远程仓库
echo "推送到远程仓库..."
git push origin main
git push origin "v$VERSION"

echo "发布完成！"
```

---

## 故障排除

### 常见构建问题

#### 1. Rust 编译错误

```bash
# 更新 Rust 工具链
rustup update

# 清理构建缓存
cargo clean
rm -rf src-tauri/target

# 重新构建
npm run tauri:build
```

#### 2. 前端构建失败

```bash
# 清理 node_modules
rm -rf node_modules package-lock.json
npm install

# 检查 TypeScript 错误
npm run type-check

# 重新构建
npm run build
```

#### 3. 依赖冲突

```bash
# 检查依赖树
npm ls
cargo tree

# 更新依赖
npm update
cargo update
```

### 平台特定问题

#### macOS

```bash
# 权限问题
sudo xcode-select --reset

# 证书问题
security find-identity -v -p codesigning
security unlock-keychain ~/Library/Keychains/login.keychain

# 公证问题
xcrun altool --list-providers -u "$APPLE_ID" -p "$APPLE_PASSWORD"
```

#### Windows

```powershell
# Visual Studio Build Tools
# 确保安装了 C++ 构建工具

# 证书问题
certlm.msc  # 检查证书存储

# 权限问题
# 以管理员身份运行 PowerShell
```

#### Linux

```bash
# 缺少系统依赖
sudo apt install --fix-missing

# 权限问题
sudo chown -R $USER:$USER ~/.cargo
sudo chown -R $USER:$USER node_modules

# AppImage 问题
sudo apt install fuse
```

### 调试技巧

#### 1. 启用详细日志

```bash
# Rust 日志
RUST_LOG=debug npm run tauri:build

# Tauri 日志
TAURI_DEBUG=1 npm run tauri:dev

# npm 日志
npm run tauri:build --verbose
```

#### 2. 检查构建输出

```bash
# 检查二进制文件
file src-tauri/target/release/claudia
ldd src-tauri/target/release/claudia  # Linux
otool -L src-tauri/target/release/claudia  # macOS

# 检查包大小
du -h src-tauri/target/release/bundle/
```

#### 3. 测试安装包

```bash
# macOS
open src-tauri/target/release/bundle/macos/Claudia.app

# Windows
start src-tauri/target/release/bundle/windows/Claudia.exe

# Linux
./src-tauri/target/release/bundle/linux/claudia
```

---

## 最佳实践

### 版本管理

1. **语义化版本**: 使用 `major.minor.patch` 格式
2. **自动化版本**: 使用脚本自动更新版本号
3. **变更日志**: 维护详细的 CHANGELOG.md
4. **标签管理**: 为每个发布版本创建 Git 标签

### 安全性

1. **代码签名**: 所有发布版本都应该签名
2. **密钥管理**: 使用安全的密钥存储方案
3. **更新验证**: 验证更新包的完整性
4. **权限最小化**: 只请求必要的系统权限

### 性能优化

1. **构建优化**: 启用 LTO 和其他优化选项
2. **资源压缩**: 压缩图片和其他资源文件
3. **依赖精简**: 移除不必要的依赖
4. **缓存利用**: 利用构建缓存加速编译

### 用户体验

1. **安装简化**: 提供简单的安装流程
2. **自动更新**: 实现无缝的自动更新
3. **错误处理**: 提供友好的错误信息
4. **多语言支持**: 支持多种语言的安装包

---

这份部署指南涵盖了 Claudia 应用从开发到生产的完整部署流程。遵循这些指南可以确保应用在各个平台上的稳定运行和良好的用户体验。